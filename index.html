<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapbox Zoom Example</title>
    <link rel="icon" type="image/png" href="image.png">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #2C2C2C;
            color: #D3D3D3;
        }
        #map {
            flex: 1;
            width: 100%;
        }
        #logo {
            position: absolute;
            top: 10px;
            right: 60px;
            z-index: 1000;
        }
        #logo img {
            width: 150px;
            height: auto;
            object-fit: contain;
            user-select: none;
            -webkit-user-drag: none;
            pointer-events: none;
        }
        #filter-container {
            position: absolute;
            top: 50px;
            left: 10px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            transition: transform 0.3s ease;
        }
        #filter-container.hidden {
            transform: translateX(-100%);
        }
        #filter-container label {
            margin-right: 10px;
            color: black;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #filter-container.compact {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        #toggle-arrow {
            position: absolute;
            top: 190px;
            left: 220px;
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #toggle-arrow:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }
        #toggle-arrow svg {
            width: 16px;
            height: 16px;
            fill: #333;
            transition: transform 0.3s ease;
        }
        #toggle-arrow.collapsed svg {
            transform: rotate(180deg);
        }
        .category-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .popup {
            background: white;
            color: black;
            padding: 10px;
            border-radius: 4px;
            font-size: 14px;
            max-width: 200px;
        }
        .popup h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        .popup p {
            margin: 0;
            font-size: 12px;
        }
        .category-row {
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            min-width: 150px;
        }
        .category-row label {
            display: block;
            width: auto;
            text-align: left;
        }
        .toggle-button {
            justify-self: end;
            padding: 0 8px;
            font-size: 18px;
            background-color: #ffffff;
            color: #333333;
            border: 1px solid #cccccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-weight: 500;
            min-width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            vertical-align: middle;
        }
        .toggle-button:hover {
            background-color: #f0f0f0;
            border-color: #999999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        .toggle-button:active {
            background-color: #e0e0e0;
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        #info-popup {
            position: absolute;
            top: 100px;
            right: 20px;
            width: 300px;
            max-height: 80vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1002;
            display: none;
            overflow-y: auto;
            color: #333;
        }
        #info-popup.show {
            display: block;
        }
        #info-popup-header {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        #info-popup-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }
        #info-popup-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #info-popup-close:hover {
            color: #333;
        }
        #info-popup-content {
            padding: 15px;
        }
        .info-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .info-item:hover {
            background-color: #f5f5f5;
        }
        .info-item:last-child {
            border-bottom: none;
        }
        .info-item h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #333;
        }
        .info-item p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        .info-item .place {
            font-weight: bold;
            color: #555;
        }
        .info-item .description {
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="logo">
        <img src="image.png" alt="È´òÂ≥∂„É≠„Ç¥">
    </div>
    <div id="filter-container" class="compact">
        <!-- ÂàùÊúüË°®Á§∫„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÂâäÈô§ -->
    </div>
    <button id="toggle-arrow" title="„Ç´„ÉÜ„Ç¥„É™„Éº„ÇíË°®Á§∫/ÈùûË°®Á§∫">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
        </svg>
    </button>
    <div id="info-popup">
        <div id="info-popup-header">
            <h3 id="info-popup-title">„Ç´„ÉÜ„Ç¥„É™„ÉºÊÉÖÂ†±</h3>
            <button id="info-popup-close">√ó</button>
        </div>
        <div id="info-popup-content">
            <!-- ÊÉÖÂ†±„Åå„Åì„Åì„Å´ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Åæ„Åô -->
        </div>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZ2dwbGF5ZXIiLCJhIjoiY200OXBzcmI1MGR6bzJxcTFrdDJ1MGJyNSJ9.o_VpEScSsAPdt8U8PDB58Q';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            projection: 'globe',
            zoom: 4, // Êó•Êú¨ÂÖ®‰Ωì„ÅåË¶ã„Åà„Çã„Ç∫„Éº„É†„É¨„Éô„É´
            center: [138, 36] // Êó•Êú¨„ÅÆ‰∏≠ÂøÉÂ∫ßÊ®ô
        });

        map.addControl(new mapboxgl.NavigationControl());
        map.on('style.load', () => {
            map.setFog({});
        });

        // È´òÂ≥∂Â∏Ç‰ª•Â§ñ„ÇíÈõ≤„ÅßÈö†„Åô„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        function applyFogAnimation() {
            // ÂàùÊúüÁä∂ÊÖã„ÅÆFogË®≠ÂÆö
            map.setFog({
                range: [0.5, 10], // Ë¶ñÁïå„ÅÆÁØÑÂõ≤
                color: 'white', // Èõ≤„ÅÆËâ≤
                "horizon-blend": 0.1 // Âú∞Âπ≥Á∑ö„ÅÆ„Åº„Åã„Åó
            });

            // GSAP„ÅßFog„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÂÆüË°å
            gsap.to(map.getFog(), {
                duration: 2, // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆÊôÇÈñì
                range: [0.1, 2], // Ë¶ñÁïå„ÇíÁã≠„ÇÅ„Çã
                "horizon-blend": 0.8, // Âú∞Âπ≥Á∑ö„ÅÆ„Åº„Åã„Åó„ÇíÂº∑„Åè„Åô„Çã
                onUpdate: () => {
                    // Fog„ÅÆË®≠ÂÆö„ÇíÊõ¥Êñ∞
                    map.setFog({
                        range: gsap.getProperty(map.getFog(), "range"),
                        color: 'white',
                        "horizon-blend": gsap.getProperty(map.getFog(), "horizon-blend")
                    });
                }
            });
        }

        // È´òÂ≥∂Â∏Ç„ÅÆÁØÑÂõ≤„ÇíÂº∑Ë™ø„Åô„ÇãÈñ¢Êï∞
        function highlightTakasima() {
            map.flyTo({
                center: [135.94635242951762, 35.37786887726864], // È´òÂ≥∂Â∏Ç„ÅÆÂ∫ßÊ®ô
                zoom: 10, // È´òÂ≥∂Â∏Ç„ÅåË¶ã„Åà„Çã„Ç∫„Éº„É†„É¨„Éô„É´
                pitch: 45, // ÂÇæ„Åç
                bearing: 0, // ÂõûËª¢ËßíÂ∫¶
                speed: 0.8, // „Ç∫„Éº„É†ÈÄüÂ∫¶
                curve: 1.5 // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆÊõ≤Á∑ö
            });

            // Fog„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈÅ©Áî®
            applyFogAnimation();
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂæå„Å´È´òÂ≥∂Â∏Ç„ÇíÂº∑Ë™ø
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(highlightTakasima, 2000); // 2ÁßíÂæå„Å´„Ç∫„Éº„É†„Å®Fog„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈñãÂßã
        });

        const sheetNames = ['takasima_map'];
        const spreadsheetId = '1AZgfYRfWLtVXH7rx7BeEPmbmdy7EfnGDbAwi6bMSNsU';
        const apiKey = 'AIzaSyAj_tQf-bp0v3j6Pl8S7HQVO5I-D5WI0GQ';
        let data = {};
        let markers = []; // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶ÂÆöÁæ©
        let categories = new Set(); // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶ÂÆöÁæ©

        async function fetchData(sheetName) {
            console.log('Fetching data from', sheetName);
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}?key=${apiKey}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }
                const data = await response.json();
                console.log('Raw data from spreadsheet:', data.values); // „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞„ÇíËøΩÂä†
                data.values.shift(); // ÊúÄÂàù„ÅÆË°å„ÇíÂâäÈô§
                return data.values;
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        // „Ç´„ÉÜ„Ç¥„É™„Éº„Åî„Å®„ÅÆËâ≤„Å®„Çµ„Ç§„Ç∫„ÇíÂÆöÁæ©
        const CATEGORY_STYLES = {
            'Â±±': { color: '#3357FF', size: 8 },
            '„Ç≠„É£„É≥„ÉóÂ†¥': { color: '#33FF57', size: 8 },
            'Ë¶≥ÂÖâÂú∞Âêç': { color: 'black', size: 8 },
            '„Ç§„Éô„É≥„Éà': { color: '#FFD700', size: 8 },
            'Á•ûÁ§æ': { color: '#8A2BE2', size: 8 },
            'ÂÆøÊ≥äÊñΩË®≠': { color: '#FF69B4', size: 8 },
            'È£≤È£üÂ∫ó': { color: '#FF4500', size: 8 }
        };

        async function init() {
            const points = await fetchData(sheetNames[0]);
            if (!points) return;

            // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Çí„ÇØ„É™„Ç¢
            markers = [];
            categories.clear();

            points.forEach(point => {
                const [id, category, subcategory, name, place, latitude, longitude, description, link] = point;
                console.log('Processing point:', { id, category, name, latitude, longitude });
                
                // Â∫ßÊ®ô„ÅÆÂá¶ÁêÜ„ÇíÊîπÂñÑ
                let lat, lon;
                try {
                    lat = parseFloat(latitude?.replace(/,/g, '.'));
                    lon = parseFloat(longitude?.replace(/,/g, '.'));
                } catch (e) {
                    console.error(`Error parsing coordinates for point: ${name}`, e);
                    return;
                }

                if (isNaN(lat) || isNaN(lon) || lat === 0 || lon === 0) {
                    console.error(`Invalid coordinates for point: ${name} (lat: ${latitude}, lon: ${longitude})`);
                    return;
                }

                categories.add(category);
                markers.push({
                    id,
                    category,
                    coordinates: [lon, lat],
                    properties: {
                        name,
                        place,
                        description,
                        link
                    }
                });
            });

            console.log('All categories found:', Array.from(categories));
            console.log('Valid markers count:', markers.length);

            map.on('load', () => {
                // „ÇΩ„Éº„Çπ„ÇíËøΩÂä†
                map.addSource('markers', {
                    type: 'geojson',
                    data: {
                        type: 'FeatureCollection',
                        features: markers.map(marker => ({
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: marker.coordinates
                            },
                            properties: {
                                ...marker.properties,
                                category: marker.category
                            }
                        }))
                    }
                });

                // „É¨„Ç§„É§„Éº„ÇíËøΩÂä†
                map.addLayer({
                    id: 'marker-layer',
                    type: 'circle',
                    source: 'markers',
                    paint: {
                        'circle-radius': [
                            'match',
                            ['get', 'category'],
                            ...Object.entries(CATEGORY_STYLES).flatMap(([cat, style]) => [cat, style.size]),
                            6 // „Éá„Éï„Ç©„É´„Éà„Çµ„Ç§„Ç∫
                        ],
                        'circle-color': [
                            'match',
                            ['get', 'category'],
                            ...Object.entries(CATEGORY_STYLES).flatMap(([cat, style]) => [cat, style.color]),
                            '#CCCCCC' // „Éá„Éï„Ç©„É´„Éà„Ç´„É©„Éº
                        ],
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#FFFFFF'
                    }
                });

                // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆ‰ΩúÊàê
                const popup = new mapboxgl.Popup({
                    closeButton: false,
                    closeOnClick: false
                });

                let isPopupFixed = false; // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅåÂõ∫ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã„Åã„Å©„ÅÜ„Åã„ÅÆ„Éï„É©„Ç∞

                // „Éû„Ç¶„Çπ„Ç™„Éº„Éê„ÉºÊôÇ„ÅÆ„Ç§„Éô„É≥„Éà
                map.on('mouseenter', 'marker-layer', (e) => {
                    map.getCanvas().style.cursor = 'pointer';
                    if (!isPopupFixed) { // Âõ∫ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÊñ∞„Åó„ÅÑ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
                        const features = map.queryRenderedFeatures(e.point, {
                            layers: ['marker-layer']
                        });

                        if (features.length > 0) {
                            const feature = features[0];
                            const coordinates = feature.geometry.coordinates.slice();
                            const properties = feature.properties;

                            const html = `
                                <div class="popup">
                                    <h3>${properties.name}</h3>
                                    <p>${properties.place || ''}</p>
                                    ${properties.description ? `<p>${properties.description}</p>` : ''}
                                    ${properties.link ? `<p><a href="${properties.link}" target="_blank">Ë©≥Á¥∞„ÇíË¶ã„Çã</a></p>` : ''}
                                </div>
                            `;

                            popup.setLngLat(coordinates)
                                .setHTML(html)
                                .addTo(map);
                        }
                    }
                });

                map.on('mouseleave', 'marker-layer', () => {
                    map.getCanvas().style.cursor = '';
                    if (!isPopupFixed) { // Âõ∫ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÊ∂à„Åô
                        popup.remove();
                    }
                });

                // „Éû„Éº„Ç´„Éº„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
                map.on('click', 'marker-layer', (e) => {
                    const features = map.queryRenderedFeatures(e.point, {
                        layers: ['marker-layer']
                    });

                    if (features.length > 0) {
                        const feature = features[0];
                        const coordinates = feature.geometry.coordinates.slice();
                        const properties = feature.properties;

                        const html = `
                            <div class="popup">
                                <h3>${properties.name}</h3>
                                <p>${properties.place || ''}</p>
                                ${properties.description ? `<p>${properties.description}</p>` : ''}
                                ${properties.link ? `<p><a href="${properties.link}" target="_blank">Ë©≥Á¥∞„ÇíË¶ã„Çã</a></p>` : ''}
                            </div>
                        `;

                        // Êó¢Â≠ò„ÅÆ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÂâäÈô§
                        popup.remove();

                        // Êñ∞„Åó„ÅÑ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
                        popup.setLngLat(coordinates)
                            .setHTML(html)
                            .addTo(map);

                        isPopupFixed = true; // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÂõ∫ÂÆöÁä∂ÊÖã„Å´
                    }
                });

                // „Éû„ÉÉ„Éó„ÅÆ‰ªñ„ÅÆÈÉ®ÂàÜ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÊôÇ„ÅÆ„Ç§„Éô„É≥„Éà
                map.on('click', (e) => {
                    const features = map.queryRenderedFeatures(e.point, {
                        layers: ['marker-layer']
                    });
                    
                    if (features.length === 0) {
                        popup.remove();
                        isPopupFixed = false; // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆÂõ∫ÂÆö„ÇíËß£Èô§
                    }
                });

                // „Éï„Ç£„É´„Çø„Éº„Ç≥„É≥„ÉÜ„Éä„ÅÆÊõ¥Êñ∞
                const filterContainer = document.getElementById('filter-container');
                filterContainer.innerHTML = ''; // Êó¢Â≠ò„ÅÆÂÜÖÂÆπ„Çí„ÇØ„É™„Ç¢

                // ÂÆüÈöõ„Å´Â≠òÂú®„Åô„Çã„Ç´„ÉÜ„Ç¥„É™„Éº„ÅÆ„Åø„Çí„Éï„Ç£„É´„Çø„Éº„Å´ËøΩÂä†
                Array.from(categories).forEach(category => {
                    const style = CATEGORY_STYLES[category] || { color: '#CCCCCC', size: 6 };
                    const categoryRow = document.createElement('div');
                    categoryRow.className = 'category-row';
                    
                    const categoryLabel = document.createElement('label');
                    categoryLabel.innerHTML = `
                        <input type="checkbox" class="category-filter" data-category="${category}" checked>
                        <span class="category-color" style="background-color: ${style.color}"></span>
                        ${category}
                    `;

                    const toggleButton = document.createElement('button');
                    toggleButton.className = 'toggle-button';
                    toggleButton.innerHTML = 'üîç';
                    toggleButton.title = '„Åì„Çå„Å†„ÅëË°®Á§∫';
                    let isSoloMode = false; // Âçò‰∏ÄË°®Á§∫„É¢„Éº„Éâ„ÅÆÁä∂ÊÖã„ÇíÁÆ°ÁêÜ

                    toggleButton.onclick = (e) => {
                        e.preventDefault();
                        const checkboxes = document.querySelectorAll('.category-filter');
                        const currentCategory = category;
                        
                        if (!isSoloMode) {
                            // Âçò‰∏ÄË°®Á§∫„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
                            checkboxes.forEach(checkbox => {
                                if (checkbox.dataset.category === currentCategory) {
                                    checkbox.checked = true;
                                } else {
                                    checkbox.checked = false;
                                }
                            });
                            toggleButton.title = 'ÂÖ®Ë°®Á§∫';
                            isSoloMode = true;
                            
                            // ÊÉÖÂ†±„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫
                            showCategoryInfo(currentCategory);
                        } else {
                            // ÂÖ®Ë°®Á§∫„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà
                            checkboxes.forEach(checkbox => {
                                checkbox.checked = true;
                            });
                            toggleButton.title = '„Åì„Çå„Å†„ÅëË°®Á§∫';
                            isSoloMode = false;
                            
                            // ÊÉÖÂ†±„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÈùûË°®Á§∫
                            hideInfoPopup();
                        }
                        
                        updateMarkers();
                    };

                    categoryRow.appendChild(categoryLabel);
                    categoryRow.appendChild(toggleButton);
                    filterContainer.appendChild(categoryRow);
                });

                // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞Ê©üËÉΩ
                function updateMarkers() {
                    const activeCategories = Array.from(document.querySelectorAll('.category-filter:checked')).map(
                        checkbox => checkbox.dataset.category
                    );

                    const filteredFeatures = markers
                        .filter(({ category }) => activeCategories.includes(category))
                        .map(marker => ({
                            type: 'Feature',
                            geometry: {
                                type: 'Point',
                                coordinates: marker.coordinates
                            },
                            properties: {
                                ...marker.properties,
                                category: marker.category
                            }
                        }));

                    // GeoJSON„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                    const source = map.getSource('markers');
                    if (source) {
                        source.setData({
                            type: 'FeatureCollection',
                            features: filteredFeatures
                        });
                    } else {
                        console.error("Source 'markers' is not defined.");
                    }
                }

                // „Ç´„ÉÜ„Ç¥„É™„Éï„Ç£„É´„Çø„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
                document.querySelectorAll('.category-filter').forEach(checkbox => {
                    checkbox.addEventListener('change', updateMarkers);
                });

                // ÂàùÊúü„Éï„Ç£„É´„Çø„É™„É≥„Ç∞„ÇíÂÆüË°å
                updateMarkers();
            });
        }

        // È´òÂ≥∂Â∏Ç„ÅÆÂ§ñÊû†„ÇíÊèèÁîª„Åô„ÇãÈñ¢Êï∞
        function drawOuterBoundary(geojsonData) {
            map.on('load', () => {
                map.addLayer({
                    id: 'takasima-outer-boundary',
                    type: 'line',
                    source: {
                        type: 'geojson',
                        data: geojsonData // Êñ∞„Åó„ÅÑGeoJSON„Éá„Éº„Çø„Çí‰ΩøÁî®
                    },
                    layout: {},
                    paint: {
                        'line-color': '#FF0000', // Ëµ§Ëâ≤
                        'line-width': 3 // „É©„Ç§„É≥„ÅÆÂπÖ
                    }
                });
            });
        }

        // GeoJSON„Éï„Ç°„Ç§„É´„ÇíË™≠„ÅøËæº„ÇÄÈñ¢Êï∞
        async function fetchBoundaryData() {
            try {
                const response = await fetch('./map.geojson'); // GeoJSON„Éï„Ç°„Ç§„É´„ÅÆ„Éë„Çπ
                if (!response.ok) {
                    throw new Error('Failed to fetch GeoJSON data');
                }
                const geojsonData = await response.json();
                drawOuterBoundary(geojsonData); // Â§ñÊû†„ÇíÊèèÁîª
            } catch (error) {
                console.error('Error fetching GeoJSON data:', error);
            }
        }

        // Áü¢Âç∞„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
        document.getElementById('toggle-arrow').addEventListener('click', () => {
            const filterContainer = document.getElementById('filter-container');
            const toggleArrow = document.getElementById('toggle-arrow');
            
            filterContainer.classList.toggle('hidden');
            toggleArrow.classList.toggle('collapsed');
            
            // Áü¢Âç∞„Éú„Çø„É≥„ÅÆ‰ΩçÁΩÆ„ÇÇË™øÊï¥
            if (filterContainer.classList.contains('hidden')) {
                toggleArrow.style.left = '20px'; // „Ç´„ÉÜ„Ç¥„É™„ÉºÊ¨Ñ„ÅåÈö†„Çå„ÅüÊôÇ„ÅÆ‰ΩçÁΩÆ
            } else {
                toggleArrow.style.left = '220px'; // „Ç´„ÉÜ„Ç¥„É™„ÉºÊ¨Ñ„ÅåË°®Á§∫„Åï„Çå„ÅüÊôÇ„ÅÆ‰ΩçÁΩÆ
            }
        });

        // ÊÉÖÂ†±„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞
        function showCategoryInfo(category) {
            const infoPopup = document.getElementById('info-popup');
            const infoPopupTitle = document.getElementById('info-popup-title');
            const infoPopupContent = document.getElementById('info-popup-content');
            
            // „Çø„Ç§„Éà„É´„ÇíÊõ¥Êñ∞
            infoPopupTitle.textContent = `${category}„ÅÆÊÉÖÂ†±`;
            
            // „Ç´„ÉÜ„Ç¥„É™„Éº„Å´Ë©≤ÂΩì„Åô„Çã„Éû„Éº„Ç´„Éº„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
            const categoryMarkers = markers.filter(marker => marker.category === category);
            
            // „Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÁîüÊàê
            let contentHTML = '';
            categoryMarkers.forEach(marker => {
                contentHTML += `
                    <div class="info-item" onclick="flyToMarker(${marker.coordinates[0]}, ${marker.coordinates[1]})">
                        <h4>${marker.properties.name}</h4>
                        ${marker.properties.place ? `<p class="place">${marker.properties.place}</p>` : ''}
                        ${marker.properties.description ? `<p class="description">${marker.properties.description}</p>` : ''}
                    </div>
                `;
            });
            
            infoPopupContent.innerHTML = contentHTML;
            infoPopup.classList.add('show');
        }

        // ÊÉÖÂ†±„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíÈùûË°®Á§∫„Å´„Åô„ÇãÈñ¢Êï∞
        function hideInfoPopup() {
            const infoPopup = document.getElementById('info-popup');
            infoPopup.classList.remove('show');
        }

        // „Éû„Éº„Ç´„Éº„Å´È£õ„Å∂Èñ¢Êï∞
        function flyToMarker(lon, lat) {
            map.flyTo({
                center: [lon, lat],
                zoom: 15,
                speed: 1.2
            });
        }

        // „Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆÈñâ„Åò„Çã„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        document.getElementById('info-popup-close').addEventListener('click', hideInfoPopup);

        // ÂàùÊúüÂåñÈñ¢Êï∞„ÇíÂëº„Å≥Âá∫„Åô
        fetchBoundaryData();

        init();
    </script>
</body>
</html>